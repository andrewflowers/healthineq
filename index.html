<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script src="jquery.min.js"></script>
    <script src="d3-jetpack.js"></script>
    <script src="selectize.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/stylesheet.css">
	  
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Health Inequality Data Visualizations, by Andrew Flowers</title>
    
    <style>

.cz {
  stroke: white;
  stroke-width: .5px;
  stroke-linejoin: round;
}

.state {
  fill: none;
  stroke: white;
  stroke-width: .8px;
  stroke-linejoin: round;
}

#tooltip{
  position: absolute;
  z-index: 2;
  background: white; /* gba(0,153,76,0.8); */
  width:130px;
  height:60px;
  color:black;
  font-size: 15px;
  padding:5px;
  top:-150px;
  left:-150px;
  font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
}

#tooltip svg {
	border-top: 0;
	margin-left: -5px;
	margin-top: 7px;
}

#tooltip.hidden {
	display: none;
}


body { font-family: 'Helvetica Neue', Helvetica; font-weight: 300; padding: 20px;}
th { text-align: left; }
th, td { padding: 0 1em 0.5ex 0;}
th.center, td.center { text-align: center; }
th.num, td.num { text-align: right; }	    
	    
</style>
  </head>

  <body>
    <header>
      <div class="inner">
        <h2>Health inequality data visualizations</h2>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h3>
<a id="interactive-map-of-life-expectancy-by-commuting-zone" class="anchor" href="#interactive-map-of-life-expectancy-by-commuting-zone" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Interactive map of life expectancy by commuting zone</h3>
        </section>
      
        
<div id="tooltip" class="hidden"></div>
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-queue.v2.min.js"></script>
<script>

var width = 1500, // 960
    height = 800; // 500

var projection = d3.geo.albersUsa()
    .scale([1500])
    .translate([width / 2, height / 2]);

var path = d3.geo.path().
	projection(projection);

var svg = d3.select("body")
	.append("svg")
    .attr("width", width)
    .attr("height", height);

var color = d3.scale.quantize()
	.range(["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"])
	.domain([77.85, 86.31]);


var hover = function(d) {
    console.log('d', d, 'event', event);
    d3.select("#tooltip").classed("hidden", false);

    var div = document.getElementById('tooltip');
    div.style.left = event.pageX +'px';
    div.style.top = event.pageY + 'px';
    if (d.properties.czname) {
    	div.innerHTML = 'In the ' + 
    				d.properties.czname +
    				' area, life expectancy is ' +
    				Math.round(parseFloat(d.properties.le_raceadj_q1_F)*10)/10 + '.';
    			} else {
    				div.innerHTML = 'No data';
    			}
    


    d3.select(this.parentNode.appendChild(this)).transition().duration(300)
        .style({'stroke-width':'1.3px','stroke':'black'});
  };

d3.json("cz_and_states_data.json", function(error, data) {
  
  if (error) return console.error(error);

  var commuting_zones = topojson.feature(data, data.objects.commuting_zones).features,
  	  states = topojson.feature(data, data.objects.states);

  svg.selectAll("path")
      .data(commuting_zones)
      .enter()
      .append("path")
      .attr("d", path)
      .attr("fill", function(d) { 
      			var value = d.properties.le_raceadj_q1_F;

      			if (value) {
      				return color(value);
      			} else {
      				return "#f2ebeb";
      			}
       })
      .attr("class", "cz")
      .on("mouseover", hover)
      .on("mouseout", function() { 
      	d3.select("#tooltip").classed("hidden", true);
      	d3.select(this).transition().duration(300)
        .style({'stroke-width':'.5px','stroke':'white'})
      });

  svg.append("path")
      .data([states])
      .attr("d", path)
      .attr("class", "state");
     
});

</script>
    <div class="separator">&nbsp;</div>
      </div>
    </div>
    <div id="wrapper">
            <h1>Health metrics by similar locations</h1>
            <div class="demo">
                <p>Enter your city and state to see similar areas and their health metrics:</p>
                <div class="control-group">
                    <label for="select-state">State:</label>
                    <select id="select-state" class="contacts" placeholder="Enter state..."></select>
                </div>
                <div class="control-group">
                    <label for="select-city">City:</label>
                    <select id="select-city" class="contacts" placeholder="Enter city..."></select>
                </div>
                <script>
                
                var select_state, $select_state;
                var select_city, $select_city;
                var current_state, current_city;

                function update_state(state_selection){
                    current_state = state_selection;  
                }

                function update_city(city_selection){
                    current_city = city_selection;  
                }

                d3.csv("cz_names_and_states.csv", function(names) {
                
                    $select_state = $('#select-state').selectize({
                        create: false,
                        persist: false, 
                        maxItems: 1,
                        maxOptions: null,
                        closeAfterSelect: true,
                        sortField: {field: 'state'},
                        valueField: 'state',
                        labelField: 'state',
                        searchField: ['state'],

                        // Details
                        options: names,
                        onChange: function(state_selection) {
                            if (!state_selection.length) return;
                            select_city.disable();
                            select_city.clearOptions();
                            select_city.load(function(callback) {
                                    select_city.enable();
                                    //callback(names); // Filter by state 
                                    callback(names.filter(function(d) {
                                        return d.state == state_selection;
                                    }));
                            });
                            update_state(state_selection);
                        }
                    });

                    $select_city = $('#select-city').selectize({
                        create: false,
                        persist: false, 
                        maxItems: 1,
                        maxOptions: null,
                        closeAfterSelect: true,
                        sortField: {field: 'city'},
                        valueField: 'city',
                        labelField: 'city',
                        searchField: ['city'],   
                        
                        // Details
                        onChange: function(city_selection){
                            update_city(city_selection);
                            console.log("Your selection is " +
                                current_city + ", " +
                                current_state + "!");
                        }

                    });

                    select_city  = $select_city[0].selectize;
                    select_state = $select_state[0].selectize;

                    select_city.disable();

                });

                </script>
            </div>
        </div>

    <div class="separator">&nbsp;</div>

    <script>
    // Create table
    var health_data;

    d3.csv("sample_table_data.csv", function(data) {
        
        health_data = data;
    
        // column definitions
        var columns = [
            { head: 'Location', cl: 'title', html: ƒ('location') },
            { head: 'Smoking', cl: 'num', html: ƒ('cur_smoke_q1') },
            { head: 'Obesity', cl: 'num', html: ƒ('bmi_obese_q1') },
            { head: 'Exercise', cl: 'num', html: ƒ('exercise_any_q1') },
            { head: 'Poverty', cl: 'num', html: ƒ('poor_share') }
        ];

        
        d3.select("body").append("div")
          .attr("id", "container")

        d3.select("#container").append("div")
          .attr("id", "FilterableTable");

        var table = d3.select("#FilterableTable").append("table"); 

        table.append('thead').append('tr')
            .selectAll('th')
            .data(columns).enter()
            .append('th')
            .attr('class', ƒ('cl'))
            .text(ƒ('head'));

        // create table body
        table.append('tbody')
            .selectAll('tr')
            .data(health_data).enter()
            .append('tr')
            .selectAll('td')
            .data(function(row, i) {
                return columns.map(function(c) {
                    // compute cell values for this specific row
                    var cell = {};
                    d3.keys(c).forEach(function(k) {
                        cell[k] = typeof c[k] == 'function' ? c[k](row,i) : c[k];
                    });
                    return cell;
                });
            }).enter()
            .append('td')
            .html(ƒ('html'))
            .attr('class', ƒ('cl'));

        d3.select("#search")
            .on("keyup", function() { 
            var text = this.value.trim();
            console.log(text);
        });

    });



    </script>	  
  </body>
</html>
