<!DOCTYPE html>
<html>
<head>
    <title>Health measures of similar areas</title>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://rawgit.com/gka/d3-jetpack/master/d3-jetpack.js"></script>
    <script src="jquery.min.js"></script>
    <script src="selectize.js"></script>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/stylesheet.css">
    <style type="text/css">
    body { font-family: 'Helvetica Neue', Helvetica; font-weight: 300; padding: 20px;}
    th { text-align: left; }
    th, td { padding: 0 1em 0.5ex 0;}
    th.center, td.center { text-align: center; }
    th.num, td.num { text-align: right; }
    </style>
</head>
<body>
    <div id="wrapper">
            <h1>Health metrics by similar locations</h1>
            <div class="demo">
                <p>Enter your city and state to see similar areas and their health metrics:</p>
                <div class="control-group">
                    <label for="select-state">State:</label>
                    <select id="select-state" class="contacts" placeholder="Enter state..."></select>
                </div>
                <div class="control-group">
                    <label for="select-city">City:</label>
                    <select id="select-city" class="contacts" placeholder="Enter city..."></select>
                </div>
                <script>
                
                var select_state, $select_state;
                var select_city, $select_city;
                var current_state, current_city;

                function update_state(state_selection){
                    current_state = state_selection;  
                }

                function update_city(city_selection){
                    current_city = city_selection;  
                }

                d3.csv("cz_names_and_states.csv", function(names) {
                
                    $select_state = $('#select-state').selectize({
                        create: false,
                        persist: false, 
                        maxItems: 1,
                        maxOptions: null,
                        closeAfterSelect: true,
                        sortField: {field: 'state'},
                        valueField: 'state',
                        labelField: 'state',
                        searchField: ['state'],

                        // Details
                        options: names,
                        onChange: function(state_selection) {
                            if (!state_selection.length) return;
                            select_city.disable();
                            select_city.clearOptions();
                            select_city.load(function(callback) {
                                    select_city.enable();
                                    //callback(names); // Filter by state 
                                    callback(names.filter(function(d) {
                                        return d.state == state_selection;
                                    }));
                            });
                            update_state(state_selection);
                        }
                    });

                    $select_city = $('#select-city').selectize({
                        create: false,
                        persist: false, 
                        maxItems: 1,
                        maxOptions: null,
                        closeAfterSelect: true,
                        sortField: {field: 'city'},
                        valueField: 'city',
                        labelField: 'city',
                        searchField: ['city'],   
                        
                        // Details
                        onChange: function(city_selection){
                            update_city(city_selection);
                            update_location(current_city + ", " + current_state);
                            if (current_city.length > 0) update_table();
                        }

                    });

                    select_city  = $select_city[0].selectize;
                    select_state = $select_state[0].selectize;

                    select_city.disable();

                });

                </script>
            </div>
        </div>

    <div class="separator">&nbsp;</div>

    <script>

    // Default selection
    var selection = "Johnson City, TN"; 

    function update_location(location){
        selection = location;
    }

    var health_data;

    function get_selected_data(selection) {
    
        return health_data.filter(function(d) { 
            return d.location == selection;
        })

    }

    function calcSimilarity(selection) {
    
        var selected_data = get_selected_data(selection);
        
        return health_data.map(function(d, i) {
            return Math.pow((selected_data[0].asian - d.asian), 2) +
                Math.pow((selected_data[0].black - d.black), 2) +
                Math.pow((selected_data[0].white - d.white), 2) +
                Math.pow((selected_data[0].hispanic - d.hispanic), 2) +
                Math.pow((selected_data[0].male - d.male), 2) +
                Math.pow((selected_data[0].age_0_to_19 - d.age_0_to_19), 2) +
                Math.pow((selected_data[0].age_20_to_39 - d.age_20_to_39), 2) +
                Math.pow((selected_data[0].age_40_to_64 - d.age_40_to_64), 2) +
                Math.pow((selected_data[0].age_over_64 - d.age_over_64), 2);
        })
    }

    // Table column headers
    var columns = [
        { head: 'Location', cl: 'title', html: ƒ('location') },
        { head: 'Smoking', cl: 'num', html: ƒ('cur_smoke_q1') },
        { head: 'Obesity', cl: 'num', html: ƒ('bmi_obese_q1') },
        { head: 'Exercise', cl: 'num', html: ƒ('exercise_any_q1') },
        { head: 'Poverty', cl: 'num', html: ƒ('poor_share') },
        { head: 'Similarity Score', cl: 'num', html: ƒ('similarity') }
    ];

    // Create table
    var table, similarity_scores;

    d3.csv("cz_health_and_demo_data.csv", function(data) {
        
        health_data = data;

        similarity_scores = calcSimilarity(selection);

        health_data.forEach(function(cz, i) {
            cz.similarity = similarity_scores[i];
        })
    
        d3.select("body").append("div")
          .attr("id", "container")

        d3.select("#container").append("div")
          .attr("id", "FilterableTable");

        table = d3.select("#FilterableTable").append("table"); 

        table.append('thead').append('tr')
            .selectAll('th')
            .data(columns).enter()
            .append('th')
            .attr('class', ƒ('cl'))
            .text(ƒ('head'));

        // create table body
        table.append('tbody')
            .selectAll('tr')
            .data(health_data.sort(function(a, b){
                return a.similarity - b.similarity;
            })).enter()
            .append('tr')
            .selectAll('td')
            .data(function(row, i) {
                return columns.map(function(c) {
                    // compute cell values for this specific row
                    var cell = {};
                    d3.keys(c).forEach(function(k) {
                        cell[k] = typeof c[k] == 'function' ? c[k](row,i) : c[k];
                    });
                    return cell;
                });
            }).enter()
            .append('td')
            .html(ƒ('html'))
            .attr('class', ƒ('cl'));

        d3.select("#search")
            .on("keyup", function() { 
            var text = this.value.trim();
            console.log(text);
        });

    });

    function update_table() {

        similarity_scores = calcSimilarity(selection);

        health_data.forEach(function(cz, i) {
            cz.similarity = similarity_scores[i];
        }) 

        // update table body
        table.selectAll('tr')
            .data(health_data.sort(function(a, b){
                return a.similarity - b.similarity;
            }))
            .selectAll('td')
            .data(function(row, i) {
                return columns.map(function(c) {
                    // compute cell values for this specific row
                    var cell = {};
                    d3.keys(c).forEach(function(k) {
                        cell[k] = typeof c[k] == 'function' ? c[k](row,i) : c[k];
                    });
                    return cell;
                });
            })
            .html(ƒ('html'))
            .attr('class', ƒ('cl'));

    }



    </script>
</body>
</html>