{
    "collab_server" : "",
    "contents" : "# Map Census demographic data from counties -> commuting zones\n\nlibrary(tidyverse)\nlibrary(haven)\nlibrary(stringr)\n\n# Crosswalk file\ncty_to_cz_map <- read_dta(\"cw_cty_czone.dta\")\n\n# Functions to convert Census tables to long format\nfix_census_table3 <- function(raw_table){\n  \n  names(raw_table) <- raw_table[1,]\n  raw_table <- raw_table[2:nrow(raw_table),]\n  \n  long_table <- raw_table %>% \n    gather(description, data, -c(1:3)) %>% \n    separate(description, sep = \";\", \n             into = c(\"coverage\", \"stat\", \"variable\")) %>% \n    filter(stat != ' Margin of Error') %>% \n    mutate(variable = str_trim(variable)) %>% \n    select(-stat)\n  \n  return(long_table)\n}\n\nfix_census_table2 <- function(raw_table){\n  \n  names(raw_table) <- raw_table[1,]\n  raw_table <- raw_table[2:nrow(raw_table),]\n  \n  long_table <- raw_table %>% \n    gather(description, data, -c(1:3)) %>% \n    separate(description, sep = \";\", \n             into = c(\"stat\", \"variable\")) %>% \n    mutate(stat = str_trim(stat)) %>% \n    filter(stat != 'Margin of Error') %>% \n    mutate(variable = str_trim(variable)) %>% \n    select(-stat) \n  \n  return(long_table)\n}\n\n# Load county-level Census demographic data\n\nage_and_sex <- fix_census_table3(read_csv(\"census_data/ACS_14_5YR_S0101_with_ann.csv\"))\n\nrace <- fix_census_table2(read_csv(\"census_data/ACS_14_5YR_B03002_with_ann.csv\"))\n\n# Clean county data\n\ncty_age <- age_and_sex %>% \n  filter(coverage == \"Total\") %>% \n  mutate(data = as.numeric(data)) %>% \n  spread(variable, data) %>% \n  select(1:4, `Total population`, starts_with(\"AGE\")) %>% \n  mutate(age_0_to_19 = `AGE - Under 5 years` + `AGE - 5 to 9 years` + `AGE - 10 to 14 years` + `AGE - 15 to 19 years`,\n         age_20_to_39 = `AGE - 20 to 24 years` + `AGE - 25 to 29 years` + `AGE - 30 to 34 years` + `AGE - 35 to 39 years`,\n         age_40_to_64 = `AGE - 40 to 44 years` + `AGE - 45 to 49 years` + `AGE - 50 to 54 years` + `AGE - 55 to 59 years` + `AGE - 60 to 64 years`,\n         age_over_64 = `AGE - 65 to 69 years` + `AGE - 70 to 74 years` + `AGE - 75 to 79 years` + `AGE - 80 to 84 years` + `AGE - 85 years and over`) %>% \n  select(-starts_with(\"AGE\", ignore.case = FALSE)) %>% \n  gather(cat, pct, -c(1:5)) %>% \n  mutate(pop = round(`Total population` * (pct)/100)) %>% \n  select(-`Total population`, -pct, -coverage) %>% \n  spread(cat, pop)\n\ncty_sex <- age_and_sex %>% \n  filter(coverage != \"Total\") %>% \n  mutate(data = as.numeric(data)) %>% \n  spread(variable, data) %>% \n  select(1:4, `Total population`) %>% \n  spread(coverage, `Total population`) %>% \n  rename(female = Female, male = Male)\n\ncty_race <- race %>% \n  mutate(variable = str_trim(variable), data = as.numeric(data)) %>% \n  filter(variable %in% c(\"Total:\",\n                         \"Not Hispanic or Latino: - White alone\",\n                         \"Not Hispanic or Latino: - Black or African American alone\",\n                         \"Not Hispanic or Latino: - Asian alone\",\n                         \"Hispanic or Latino:\")) %>% \n  spread(variable, data) %>% \n  rename(total_population = `Total:`,\n         white = `Not Hispanic or Latino: - White alone`,\n         black = `Not Hispanic or Latino: - Black or African American alone`,\n         asian = `Not Hispanic or Latino: - Asian alone`,\n         hispanic = `Hispanic or Latino:`)\n\n# Merge county data and map to commuting zones\n\ncty_data <- cty_age %>% \n  select(-Id) %>% \n  left_join(cty_sex %>% \n              select(-c(1,3)),\n            by = \"Id2\") %>% \n  left_join(cty_race %>% \n              select(-c(1,3)),\n            by = \"Id2\") %>% \n  rename(cty_fips = Id2, cty_name = Geography) \n\ncty_to_cz_map <- cty_to_cz_map %>% \n  mutate(czone = as.character(czone),\n         cty_fips = as.character(cty_fips)) %>% \n  mutate(cty_fips = str_pad(cty_fips, width = 5, side = \"left\", pad = \"0\"))\n\ncz_data <- cty_data %>% \n  left_join(cty_to_cz_map, by = \"cty_fips\") %>% \n  select(1, 2, czone, 3:13) \n\ncz_data_agg <- cz_data %>% \n  group_by(czone) %>% \n  summarize_each(funs(sum), -(1:3)) %>% \n  gather(demo_var, data, -c(czone, total_population)) %>% \n  mutate(demo_share = data/total_population) %>% \n  select(-data, -total_population) %>% \n  spread(demo_var, demo_share) %>% \n  select(1, 8, 10, 2:5, 6:7, 9, 11)\n\n# Join health metrics data\n\ncz_health_metrics <- read_csv(\"../health_ineq_data/health_ineq_online_table_10.csv\")\n\ncz_health_and_demo <- cz_health_metrics %>% \n  left_join(cz_data_agg %>% \n              mutate(czone = as.integer(czone)), \n            by = c(\"cz\" = \"czone\")) %>% \n  mutate(location = paste0(czname, \", \", stateabbrv)) %>% \n  select(1:6, 79, 7:78)\n  \n# Join life expectancy data\ncz_le_metrics <- read_csv(\"../health_ineq_data/health_ineq_online_table_6.csv\")\n\ncz_health_demo_le_data <- cz_health_and_demo %>% \n  left_join(cz_le_metrics %>% \n              select(-c(2:6)), by = \"cz\") %>% \n  mutate(puninsured2010 = puninsured2010/100)\n\nwrite_csv(cz_health_demo_le_data, \"../gh-pages/data/cz_health_demo_le_data.csv\")\n",
    "created" : 1490966343375.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1235503678",
    "id" : "8D45C7ED",
    "lastKnownWriteTime" : 1485763645,
    "last_content_update" : 1485763645,
    "path" : "~/repos/healthineq/r/cz_demo_data.R",
    "project_path" : "cz_demo_data.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}